{
  "$schema": "https://developer.microsoft.com/json-schemas/fabric/item/report/definition/visualContainer/2.5.0/schema.json",
  "name": "712b0cd1ed49d65edf2d",
  "position": {
    "x": 15.027901920521803,
    "y": 188.68365744655154,
    "z": 1000,
    "height": 856.59040946974278,
    "width": 1890.1761082256312,
    "tabOrder": 0
  },
  "visual": {
    "visualType": "deneb7E15AEF80B9E4D4F8E12924291ECE89A",
    "query": {
      "queryState": {
        "dataset": {
          "projections": [
            {
              "field": {
                "Column": {
                  "Expression": {
                    "SourceRef": {
                      "Entity": "dataset"
                    }
                  },
                  "Property": "Nivel_Source"
                }
              },
              "queryRef": "Tabla2.Nivel_Source",
              "nativeQueryRef": "Nivel_Source"
            },
            {
              "field": {
                "Column": {
                  "Expression": {
                    "SourceRef": {
                      "Entity": "dataset"
                    }
                  },
                  "Property": "Nivel_Target"
                }
              },
              "queryRef": "Tabla2.Nivel_Target",
              "nativeQueryRef": "Nivel_Target"
            },
            {
              "field": {
                "Column": {
                  "Expression": {
                    "SourceRef": {
                      "Entity": "dataset"
                    }
                  },
                  "Property": "Source"
                }
              },
              "queryRef": "Tabla2.Source",
              "nativeQueryRef": "Source"
            },
            {
              "field": {
                "Column": {
                  "Expression": {
                    "SourceRef": {
                      "Entity": "dataset"
                    }
                  },
                  "Property": "Target"
                }
              },
              "queryRef": "Tabla2.Target",
              "nativeQueryRef": "Target"
            },
            {
              "field": {
                "Column": {
                  "Expression": {
                    "SourceRef": {
                      "Entity": "dataset"
                    }
                  },
                  "Property": "Kg"
                }
              },
              "queryRef": "Tabla2.Kg",
              "nativeQueryRef": "Kg"
            },
            {
              "field": {
                "Aggregation": {
                  "Expression": {
                    "Column": {
                      "Expression": {
                        "SourceRef": {
                          "Entity": "dataset"
                        }
                      },
                      "Property": "Order"
                    }
                  },
                  "Function": 0
                }
              },
              "queryRef": "Sum(Tabla2.Order)",
              "nativeQueryRef": "Order",
              "displayName": "Order"
            }
          ]
        }
      },
      "sortDefinition": {
        "sort": [
          {
            "field": {
              "Column": {
                "Expression": {
                  "SourceRef": {
                    "Entity": "dataset"
                  }
                },
                "Property": "Nivel_Source"
              }
            },
            "direction": "Ascending"
          }
        ],
        "isDefaultSort": true
      }
    },
    "objects": {
      "stateManagement": [
        {
          "properties": {
            "viewportHeight": {
              "expr": {
                "Literal": {
                  "Value": "846.5904094697428D"
                }
              }
            },
            "viewportWidth": {
              "expr": {
                "Literal": {
                  "Value": "1880.1761082256312D"
                }
              }
            }
          }
        }
      ],
      "vega": [
        {
          "properties": {
            "provider": {
              "expr": {
                "Literal": {
                  "Value": "'vega'"
                }
              }
            },
            "jsonSpec": {
              "expr": {
                "Literal": {
                  "Value": "'{\n    \"$schema\": \"https://vega.github.io/schema/vega/v5.json\",\n    \"width\": 1400,\n    \"height\": 740,\n    \"padding\": {\n        \"top\": 20,\n        \"bottom\": 20,\n        \"left\": 220,\n        \"right\": 260\n    },\n    \"autosize\": \"none\",\n    \"background\": \"#fafafa\",\n    \"signals\": [\n        // =========================================================\n        // SECCIÓN 1: VARIABLES DE NEGOCIO (IDENTIDAD)\n        // =========================================================\n        {\n            \"name\": \"heroNode\",\n            \"value\": \"Producción Total\",\n            \"description\": \"Nodo principal para centrado superior. Es el nodo donde se acumula el total\"\n        },\n        {\n            \"name\": \"unitLabel\",\n            \"value\": \"kg\",\n            \"description\": \"Unidad de medida para etiquetas y tooltips. Puede ser Kg, $, unds, etc.\"\n        },\n        // =========================================================\n        // SECCIÓN 2: MAPEO DE COLUMNAS (ADAPTACIÓN AL DATASET)\n        // Solo modificar ''value'' con los nombres reales de tu tabla.\n        // =========================================================\n        {\n            \"name\": \"col_Source\",\n            \"value\": \"Source\",\n            \"description\": \"Columna Origen.\"\n        },\n        {\n            \"name\": \"col_Target\",\n            \"value\": \"Target\",\n            \"description\": \"Columna Destino.\"\n        },\n        {\n            \"name\": \"col_Value\",\n            \"value\": \"Kg\",\n            \"description\": \"Columna de Valor numérico.\"\n        },\n        {\n            \"name\": \"col_LevelS\",\n            \"value\": \"Nivel_Source\",\n            \"description\": \"Jerarquía Origen (1, 2...).\"\n        },\n        {\n            \"name\": \"col_LevelT\",\n            \"value\": \"Nivel_Target\",\n            \"description\": \"Jerarquía Destino.\"\n        },\n        {\n            \"name\": \"col_Order\",\n            \"value\": \"Order\",\n            \"description\": \"Orden vertical manual (1=Arriba).\"\n        },\n        // =========================================================\n        // SECCIÓN 3: PERSONALIZACIÓN VISUAL (LOOK & FEEL)\n        // =========================================================\n        {\n            \"name\": \"nodeGap\",\n            \"value\": 150,\n            \"description\": \"Espaciado vertical entre nodos.\"\n        },\n        {\n            \"name\": \"nodeThickness\",\n            \"value\": 0.88,\n            \"description\": \"Grosor de nodos (0.1 a 0.95).\"\n        },\n        {\n            \"name\": \"densityFactor\",\n            \"value\": 0.35,\n            \"description\": \"Densidad vertical del flujo.\"\n        },\n        // --- ESTILOS DE ETIQUETAS ---\n        {\n            \"name\": \"labelFontSize\",\n            \"value\": 20,\n            \"description\": \"Tamaño fuente nombre.\"\n        },\n        {\n            \"name\": \"labelFontWeight\",\n            \"value\": \"bold\",\n            \"description\": \"Peso fuente nombre.\"\n        },\n        {\n            \"name\": \"labelColorMain\",\n            \"value\": \"#005ca5\",\n            \"description\": \"Color fuente nombre.\"\n        },\n        {\n            \"name\": \"valueFontSize\",\n            \"value\": 22,\n            \"description\": \"Tamaño fuente valor.\"\n        },\n        {\n            \"name\": \"valueFontWeight\",\n            \"value\": \"600\",\n            \"description\": \"Peso fuente valor.\"\n        },\n        {\n            \"name\": \"valueColor\",\n            \"value\": \"#444\",\n            \"description\": \"Color fuente valor.\"\n        },\n        {\n            \"name\": \"pctFontSize\",\n            \"value\": 18,\n            \"description\": \"Tamaño fuente %.\"\n        },\n        {\n            \"name\": \"pctFontWeight\",\n            \"value\": \"bold\",\n            \"description\": \"Peso fuente %.\"\n        },\n        {\n            \"name\": \"pctColor\",\n            \"value\": \"#888\",\n            \"description\": \"Color fuente %.\"\n        },\n        {\n            \"name\": \"bgColorLabels\",\n            \"value\": \"rgba(250, 250, 250, 0.85)\",\n            \"description\": \"Fondo del recuadro.\"\n        },\n        // Cálculo interno de altura útil (No tocar)\n        {\n            \"name\": \"rangePixels\",\n            \"update\": \"height * densityFactor\"\n        },\n        // --- AUTORÍA ---\n        {\n            \"name\": \"authorName\",\n            \"value\": \"Manuel Vásquez Abanto - Analyst & Project Lead\",\n            \"description\": \"Fira personal del autor\"\n        },\n        {\n            \"name\": \"githubUser\",\n            \"value\": \"github.com/manuelvasquezab\",\n            \"description\": \"Tu enlace de contacto/portfolio.\"\n        }\n    ],\n    \"scales\": [\n        // PALETA DE COLORES DE NODOS\n        {\n            \"name\": \"node_colors\",\n            \"type\": \"ordinal\",\n            \"domain\": [\n                \"Fruta Cosechada\",\n                \"Fruta Comprada\",\n                \"Producción Total\",\n                \"Descarte Campo\",\n                \"Recepción Packing\",\n                \"Descarte Packing\",\n                \"Merma\",\n                \"Kilos Procesados\",\n                \"Kilos Exportables\",\n                \"Stock en Cámara\",\n                \"Venta Local (Donaciones)\",\n                \"Muestras Gratuitas\"\n            ],\n            \"range\": [\n                \"#60a5fa\",\n                \"#4A609E\",\n                \"#3b82f6\",\n                \"#ef4444\",\n                \"#10b981\",\n                \"#dc2626\",\n                \"#b91c1c\",\n                \"#19D950\",\n                \"#19D950\",\n                \"purple\",\n                \"#fb923c\",\n                \"blue\"\n            ]\n        },\n        // PALETA DE COLORES DE LAS CINTAS\n        {\n            \"name\": \"link_colors\",\n            \"type\": \"ordinal\",\n            \"domain\": [\n                \"Fruta Cosechada\",\n                \"Fruta Comprada\",\n                \"Recepción Packing\",\n                \"Descarte Campo\",\n                \"Kilos Procesados\",\n                \"Descarte Packing\",\n                \"Merma\",\n                \"Kilos Exportables\",\n                \"Stock en Cámara\",\n                \"Venta Local (Donaciones)\",\n                \"Muestras Gratuitas\"\n            ],\n            \"range\": [\n                \"#60a5fa\",\n                \"#4A609E\",\n                \"#3b82f6\",\n                \"#ef4444\",\n                \"#10b981\",\n                \"#b91c1c\",\n                \"#7f1d1d\",\n                \"#19D950\",\n                \"purple\",\n                \"#fb923c\",\n                \"blue\"\n            ]\n        },\n        // Escala horizontal (Niveles)\n        {\n            \"name\": \"x_scale\",\n            \"type\": \"band\",\n            \"range\": \"width\",\n            \"domain\": {\n                \"data\": \"nodes_calc\",\n                \"field\": \"level\",\n                \"sort\": true\n            },\n            \"paddingInner\": {\n                \"signal\": \"nodeThickness\"\n            }\n        },\n        // Escala vertical (Volumen)\n        {\n            \"name\": \"y_scale\",\n            \"type\": \"linear\",\n            \"range\": [\n                0,\n                {\n                    \"signal\": \"rangePixels\"\n                }\n            ],\n            \"domain\": {\n                \"data\": \"global_stats\",\n                \"field\": \"max_graph_vol\"\n            },\n            \"zero\": true\n        }\n    ],\n    // =========================================================\n    // SECCIÓN 4: MOTOR MATEMÁTICO (CAJA NEGRA)\n    // No se recomienda modificar esta lógica.\n    // =========================================================\n    \"data\": [\n        {\n            \"name\": \"dataset\"\n        },\n        // 1. Capa de Normalización (Traducción de nombres de columna)\n        {\n            \"name\": \"normalized_data\",\n            \"source\": \"dataset\",\n            \"transform\": [\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"_source\",\n                    \"expr\": \"datum[col_Source]\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"_target\",\n                    \"expr\": \"datum[col_Target]\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"_value\",\n                    \"expr\": \"datum[col_Value]\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"_lvl_s\",\n                    \"expr\": \"datum[col_LevelS]\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"_lvl_t\",\n                    \"expr\": \"datum[col_LevelT]\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"_order\",\n                    \"expr\": \"isValid(datum[col_Order]) ? datum[col_Order] : 9999\"\n                }\n            ]\n        },\n        // 2. Cálculo de Totales por Nodo\n        {\n            \"name\": \"nodes_flat\",\n            \"source\": \"normalized_data\",\n            \"transform\": [\n                {\n                    \"type\": \"fold\",\n                    \"fields\": [\n                        \"_source\",\n                        \"_target\"\n                    ],\n                    \"as\": [\n                        \"role\",\n                        \"name\"\n                    ]\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"level\",\n                    \"expr\": \"datum.role === ''_source'' ? datum._lvl_s : datum._lvl_t\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"is_in\",\n                    \"expr\": \"datum.role === ''_target'' ? datum._value : 0\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"is_out\",\n                    \"expr\": \"datum.role === ''_source'' ? datum._value : 0\"\n                },\n                {\n                    \"type\": \"aggregate\",\n                    \"groupby\": [\n                        \"name\",\n                        \"level\"\n                    ],\n                    \"fields\": [\n                        \"is_in\",\n                        \"is_out\",\n                        \"_order\"\n                    ],\n                    \"ops\": [\n                        \"sum\",\n                        \"sum\",\n                        \"min\"\n                    ],\n                    \"as\": [\n                        \"sum_in\",\n                        \"sum_out\",\n                        \"manual_sort\"\n                    ]\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"value\",\n                    \"expr\": \"max(datum.sum_in, datum.sum_out)\"\n                }\n            ]\n        },\n        // 3. Estadísticas Globales (Para escalas dinámicas)\n        {\n            \"name\": \"global_stats\",\n            \"source\": \"nodes_flat\",\n            \"transform\": [\n                {\n                    \"type\": \"aggregate\",\n                    \"groupby\": [\n                        \"level\"\n                    ],\n                    \"fields\": [\n                        \"value\"\n                    ],\n                    \"ops\": [\n                        \"sum\"\n                    ],\n                    \"as\": [\n                        \"col_vol\"\n                    ]\n                },\n                {\n                    \"type\": \"joinaggregate\",\n                    \"ops\": [\n                        \"max\"\n                    ],\n                    \"fields\": [\n                        \"col_vol\"\n                    ],\n                    \"as\": [\n                        \"max_graph_vol\"\n                    ]\n                }\n            ]\n        },\n        // 4. Algoritmo de Posicionamiento (Orden Manual + Volumen)\n        {\n            \"name\": \"nodes_calc\",\n            \"source\": \"nodes_flat\",\n            \"transform\": [\n                {\n                    \"type\": \"collect\",\n                    \"sort\": {\n                        \"field\": [\n                            \"level\",\n                            \"manual_sort\",\n                            \"value\"\n                        ],\n                        \"order\": [\n                            \"ascending\",\n                            \"ascending\",\n                            \"descending\"\n                        ]\n                    }\n                },\n                {\n                    \"type\": \"window\",\n                    \"sort\": {\n                        \"field\": [\n                            \"manual_sort\",\n                            \"value\"\n                        ],\n                        \"order\": [\n                            \"ascending\",\n                            \"descending\"\n                        ]\n                    },\n                    \"groupby\": [\n                        \"level\"\n                    ],\n                    \"ops\": [\n                        \"rank\"\n                    ],\n                    \"as\": [\n                        \"rank\"\n                    ]\n                },\n                {\n                    \"type\": \"window\",\n                    \"sort\": {\n                        \"field\": [\n                            \"manual_sort\",\n                            \"value\"\n                        ],\n                        \"order\": [\n                            \"ascending\",\n                            \"descending\"\n                        ]\n                    },\n                    \"groupby\": [\n                        \"level\"\n                    ],\n                    \"ops\": [\n                        \"sum\"\n                    ],\n                    \"fields\": [\n                        \"value\"\n                    ],\n                    \"as\": [\n                        \"sum_val\"\n                    ]\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"val_start\",\n                    \"expr\": \"datum.sum_val - datum.value\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"val_end\",\n                    \"expr\": \"datum.sum_val\"\n                }\n            ]\n        },\n        // 5. Generación de Coordenadas de Nodos\n        {\n            \"name\": \"nodes_render\",\n            \"source\": \"nodes_calc\",\n            \"transform\": [\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"max_graph_vol\",\n                    \"expr\": \"data(''global_stats'')[0].max_graph_vol\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"pct\",\n                    \"expr\": \"datum.value / datum.max_graph_vol\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"h_px\",\n                    \"expr\": \"scale(''y_scale'', datum.value)\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"start_px\",\n                    \"expr\": \"scale(''y_scale'', datum.val_start)\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"y0_raw\",\n                    \"expr\": \"datum.start_px + ((datum.rank - 1) * nodeGap)\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"y1_raw\",\n                    \"expr\": \"datum.y0_raw + datum.h_px\"\n                },\n                {\n                    \"type\": \"joinaggregate\",\n                    \"groupby\": [\n                        \"level\"\n                    ],\n                    \"ops\": [\n                        \"max\"\n                    ],\n                    \"fields\": [\n                        \"y1_raw\"\n                    ],\n                    \"as\": [\n                        \"col_px_height\"\n                    ]\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"offset_y\",\n                    \"expr\": \"(height - datum.col_px_height) / 2\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"y0\",\n                    \"expr\": \"datum.y0_raw + datum.offset_y\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"y1\",\n                    \"expr\": \"datum.y1_raw + datum.offset_y\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"x\",\n                    \"expr\": \"scale(''x_scale'', datum.level)\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"width\",\n                    \"expr\": \"bandwidth(''x_scale'')\"\n                }\n            ]\n        },\n        // 6. Filtro de Seguridad (Elimina nodos vacíos)\n        {\n            \"name\": \"nodes_labels\",\n            \"source\": \"nodes_render\",\n            \"transform\": [\n                {\n                    \"type\": \"filter\",\n                    \"expr\": \"datum.value > 0\"\n                }\n            ]\n        },\n        // 7. Enrutamiento de Cintas (Links)\n        {\n            \"name\": \"links_render\",\n            \"source\": \"normalized_data\",\n            \"transform\": [\n                {\n                    \"type\": \"lookup\",\n                    \"from\": \"nodes_render\",\n                    \"key\": \"name\",\n                    \"fields\": [\n                        \"_source\"\n                    ],\n                    \"values\": [\n                        \"y0\",\n                        \"manual_sort\",\n                        \"value\"\n                    ],\n                    \"as\": [\n                        \"src_node_base\",\n                        \"src_sort\",\n                        \"src_val\"\n                    ]\n                },\n                {\n                    \"type\": \"lookup\",\n                    \"from\": \"nodes_render\",\n                    \"key\": \"name\",\n                    \"fields\": [\n                        \"_target\"\n                    ],\n                    \"values\": [\n                        \"y0\",\n                        \"manual_sort\",\n                        \"value\"\n                    ],\n                    \"as\": [\n                        \"tgt_node_base\",\n                        \"tgt_sort\",\n                        \"tgt_val\"\n                    ]\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"thickness\",\n                    \"expr\": \"scale(''y_scale'', datum._value)\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"link_color_key\",\n                    \"expr\": \"datum._lvl_s === 1 ? datum._source : datum._target\"\n                },\n                {\n                    \"type\": \"stack\",\n                    \"groupby\": [\n                        \"_source\"\n                    ],\n                    \"sort\": {\n                        \"field\": [\n                            \"_order\",\n                            \"tgt_val\"\n                        ],\n                        \"order\": [\n                            \"ascending\",\n                            \"descending\"\n                        ]\n                    },\n                    \"field\": \"thickness\",\n                    \"as\": [\n                        \"s_off0\",\n                        \"s_off1\"\n                    ]\n                },\n                {\n                    \"type\": \"stack\",\n                    \"groupby\": [\n                        \"_target\"\n                    ],\n                    \"sort\": {\n                        \"field\": [\n                            \"_order\",\n                            \"src_val\"\n                        ],\n                        \"order\": [\n                            \"ascending\",\n                            \"descending\"\n                        ]\n                    },\n                    \"field\": \"thickness\",\n                    \"as\": [\n                        \"t_off0\",\n                        \"t_off1\"\n                    ]\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"y_src_mid\",\n                    \"expr\": \"datum.src_node_base + (datum.s_off0 + datum.s_off1)/2\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"y_tgt_mid\",\n                    \"expr\": \"datum.tgt_node_base + (datum.t_off0 + datum.t_off1)/2\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"x_src\",\n                    \"expr\": \"scale(''x_scale'', datum._lvl_s) + bandwidth(''x_scale'')\"\n                },\n                {\n                    \"type\": \"formula\",\n                    \"as\": \"x_tgt\",\n                    \"expr\": \"scale(''x_scale'', datum._lvl_t)\"\n                },\n                {\n                    \"type\": \"linkpath\",\n                    \"orient\": \"horizontal\",\n                    \"shape\": \"diagonal\",\n                    \"sourceX\": \"x_src\",\n                    \"sourceY\": \"y_src_mid\",\n                    \"targetX\": \"x_tgt\",\n                    \"targetY\": \"y_tgt_mid\"\n                }\n            ]\n        }\n    ],\n    // =========================================================\n    // SECCIÓN 5: CAPA DE DIBUJO (MARKS)\n    // =========================================================\n    \"marks\": [\n        // --- 1. CINTAS (LINKS) ---\n        {\n            \"type\": \"path\",\n            \"from\": {\n                \"data\": \"links_render\"\n            },\n            \"sort\": {\n                \"field\": \"thickness\",\n                \"order\": \"descending\"\n            },\n            \"encode\": {\n                \"update\": {\n                    \"path\": {\n                        \"field\": \"path\"\n                    },\n                    \"stroke\": {\n                        \"signal\": \"scale(''link_colors'', datum.link_color_key) || ''#cbd5e1''\"\n                    },\n                    \"strokeWidth\": {\n                        \"field\": \"thickness\"\n                    },\n                    \"strokeOpacity\": {\n                        \"value\": 0.45\n                    },\n                    \"strokeCap\": {\n                        \"value\": \"butt\"\n                    },\n                    \"tooltip\": {\n                        \"signal\": \"{''Flujo'': datum._source + '' ➔ '' + datum._target, ''Valor'': format(datum._value, '',.0f'') + '' '' + unitLabel, ''Proporción'': format(datum._value / datum.src_val, ''.1%'') + '' del origen''}\"\n                    }\n                },\n                \"hover\": {\n                    \"strokeOpacity\": {\n                        \"value\": 0.8\n                    }\n                }\n            }\n        },\n        // --- 2. NODOS (BARRAS) ---\n        {\n            \"type\": \"rect\",\n            \"from\": {\n                \"data\": \"nodes_render\"\n            },\n            \"encode\": {\n                \"enter\": {\n                    \"cornerRadius\": {\n                        \"value\": 2\n                    }\n                },\n                \"update\": {\n                    \"x\": {\n                        \"field\": \"x\"\n                    },\n                    \"width\": {\n                        \"field\": \"width\"\n                    },\n                    \"y\": {\n                        \"field\": \"y0\"\n                    },\n                    \"y2\": {\n                        \"field\": \"y1\"\n                    },\n                    \"fill\": {\n                        \"signal\": \"scale(''node_colors'', datum.name) || ''#94a3b8''\"\n                    },\n                    \"tooltip\": {\n                        \"signal\": \"{''Nodo'': datum.name, ''Total'': format(datum.value, '',.0f'') + '' '' + unitLabel, ''Impacto Global'': format(datum.pct, ''.1%'')}\"\n                    }\n                }\n            }\n        },\n        // --- 3. GRUPO DE ETIQUETAS ---\n        {\n            \"type\": \"group\",\n            \"name\": \"labelGroup\",\n            \"zindex\": 1,\n            \"from\": {\n                \"facet\": {\n                    \"data\": \"nodes_labels\",\n                    \"name\": \"labelFacet\",\n                    \"groupby\": [\n                        \"name\",\n                        \"value\",\n                        \"pct\",\n                        \"level\",\n                        \"x\",\n                        \"y0\",\n                        \"y1\",\n                        \"width\"\n                    ]\n                }\n            },\n            \"encode\": {\n                \"update\": {\n                    \"x\": {\n                        \"signal\": \"datum.name === heroNode ? datum.x + (datum.width / 2) : (datum.level == 1 ? datum.x - 8 : datum.x + datum.width + 8)\"\n                    },\n                    \"y\": {\n                        \"signal\": \"datum.name === heroNode ? datum.y0 - 45 : (datum.y0 + datum.y1) / 2\"\n                    },\n                    \"width\": {\n                        \"value\": 0\n                    },\n                    \"height\": {\n                        \"value\": 0\n                    }\n                }\n            },\n            \"marks\": [\n                // Nombre del Nodo\n                {\n                    \"type\": \"text\",\n                    \"from\": {\n                        \"data\": \"labelFacet\"\n                    },\n                    \"encode\": {\n                        \"update\": {\n                            \"x\": {\n                                \"value\": 0\n                            },\n                            \"y\": {\n                                \"value\": -12\n                            },\n                            \"fill\": {\n                                \"signal\": \"labelColorMain\"\n                            },\n                            \"fontWeight\": {\n                                \"signal\": \"labelFontWeight\"\n                            },\n                            \"fontSize\": {\n                                \"signal\": \"labelFontSize\"\n                            },\n                            \"baseline\": {\n                                \"value\": \"bottom\"\n                            },\n                            \"align\": {\n                                \"signal\": \"datum.name === heroNode ? ''center'' : (datum.level == 1 ? ''right'' : ''left'')\"\n                            },\n                            \"text\": {\n                                \"field\": \"name\"\n                            }\n                        }\n                    }\n                },\n                // Valor Numérico\n                {\n                    \"type\": \"text\",\n                    \"from\": {\n                        \"data\": \"labelFacet\"\n                    },\n                    \"encode\": {\n                        \"update\": {\n                            \"x\": {\n                                \"value\": 0\n                            },\n                            \"y\": {\n                                \"value\": 8\n                            },\n                            \"fill\": {\n                                \"signal\": \"valueColor\"\n                            },\n                            \"fontSize\": {\n                                \"signal\": \"valueFontSize\"\n                            },\n                            \"fontWeight\": {\n                                \"signal\": \"valueFontWeight\"\n                            },\n                            \"baseline\": {\n                                \"value\": \"middle\"\n                            },\n                            \"align\": {\n                                \"signal\": \"datum.name === heroNode ? ''center'' : (datum.level == 1 ? ''right'' : ''left'')\"\n                            },\n                            \"text\": {\n                                \"signal\": \"format(datum.value, '',.0f'') + '' '' + unitLabel\"\n                            }\n                        }\n                    }\n                },\n                // Porcentaje\n                {\n                    \"type\": \"text\",\n                    \"from\": {\n                        \"data\": \"labelFacet\"\n                    },\n                    \"encode\": {\n                        \"update\": {\n                            \"x\": {\n                                \"value\": 0\n                            },\n                            \"y\": {\n                                \"value\": 22\n                            },\n                            \"fill\": {\n                                \"signal\": \"pctColor\"\n                            },\n                            \"fontSize\": {\n                                \"signal\": \"pctFontSize\"\n                            },\n                            \"fontWeight\": {\n                                \"signal\": \"pctFontWeight\"\n                            },\n                            \"baseline\": {\n                                \"value\": \"top\"\n                            },\n                            \"align\": {\n                                \"signal\": \"datum.name === heroNode ? ''center'' : (datum.level == 1 ? ''right'' : ''left'')\"\n                            },\n                            \"text\": {\n                                \"signal\": \"format(datum.pct, ''.1%'')\"\n                            }\n                        }\n                    }\n                }\n            ]\n        },\n        // --- 4. FONDO DE ETIQUETAS ---\n        {\n            \"type\": \"rect\",\n            \"from\": {\n                \"data\": \"labelGroup\"\n            },\n            \"encode\": {\n                \"update\": {\n                    \"x\": {\n                        \"field\": \"bounds.x1\",\n                        \"offset\": -4\n                    },\n                    \"x2\": {\n                        \"field\": \"bounds.x2\",\n                        \"offset\": 4\n                    },\n                    \"y\": {\n                        \"field\": \"bounds.y1\",\n                        \"offset\": -2\n                    },\n                    \"y2\": {\n                        \"field\": \"bounds.y2\",\n                        \"offset\": 2\n                    },\n                    \"fill\": {\n                        \"signal\": \"bgColorLabels\"\n                    },\n                    \"cornerRadius\": {\n                        \"value\": 3\n                    }\n                }\n            }\n        },\n        // =========================================================\n        // SECCIÓN 6: MARCA DE AGUA Y AUTORÍA\n        // =========================================================\n        {\n            \"type\": \"text\",\n            \"encode\": {\n                \"enter\": {\n                    \"fill\": {\n                        \"value\": \"#94a3b8\"\n                    },\n                    \"fontSize\": {\n                        \"value\": 11\n                    },\n                    \"fontWeight\": {\n                        \"value\": \"normal\"\n                    }\n                },\n                \"update\": {\n                    \"x\": {\n                        \"value\": 10\n                    },\n                    \"y\": {\n                        \"signal\": \"height\"\n                    },\n                    \"text\": {\n                        \"signal\": \"''Desarrollado por: '' + authorName\"\n                    },\n                    \"align\": {\n                        \"value\": \"left\"\n                    }\n                }\n            }\n        },\n        {\n            \"type\": \"text\",\n            \"encode\": {\n                \"enter\": {\n                    \"fill\": {\n                        \"value\": \"#3b82f6\"\n                    },\n                    \"fontSize\": {\n                        \"value\": 11\n                    },\n                    \"fontWeight\": {\n                        \"value\": \"bold\"\n                    },\n                    \"cursor\": {\n                        \"value\": \"pointer\"\n                    }\n                },\n                \"update\": {\n                    \"x\": {\n                        \"value\": 10\n                    },\n                    \"y\": {\n                        \"signal\": \"height + 20\"\n                    },\n                    \"text\": {\n                        \"signal\": \"''GitHub: '' + githubUser\"\n                    },\n                    \"align\": {\n                        \"value\": \"left\"\n                    }\n                }\n            }\n        }\n    ]\n}'"
                }
              }
            },
            "jsonConfig": {
              "expr": {
                "Literal": {
                  "Value": "'{\n  \"autosize\": {\n    \"contains\": \"padding\",\n    \"type\": \"fit\"\n  }\n}'"
                }
              }
            },
            "isNewDialogOpen": {
              "expr": {
                "Literal": {
                  "Value": "false"
                }
              }
            },
            "enableTooltips": {
              "expr": {
                "Literal": {
                  "Value": "true"
                }
              }
            },
            "enableContextMenu": {
              "expr": {
                "Literal": {
                  "Value": "true"
                }
              }
            },
            "enableHighlight": {
              "expr": {
                "Literal": {
                  "Value": "false"
                }
              }
            },
            "enableSelection": {
              "expr": {
                "Literal": {
                  "Value": "false"
                }
              }
            },
            "selectionMaxDataPoints": {
              "expr": {
                "Literal": {
                  "Value": "50D"
                }
              }
            },
            "version": {
              "expr": {
                "Literal": {
                  "Value": "'6.2.0'"
                }
              }
            },
            "logLevel": {
              "expr": {
                "Literal": {
                  "Value": "2D"
                }
              }
            }
          }
        }
      ],
      "developer": [
        {
          "properties": {
            "version": {
              "expr": {
                "Literal": {
                  "Value": "'1.8.2.0'"
                }
              }
            }
          }
        }
      ],
      "editor": [
        {
          "properties": {
            "wordWrap": {
              "expr": {
                "Literal": {
                  "Value": "true"
                }
              }
            },
            "theme": {
              "expr": {
                "Literal": {
                  "Value": "'light'"
                }
              }
            }
          }
        }
      ]
    },
    "visualContainerObjects": {
      "visualTooltip": [
        {
          "properties": {
            "show": {
              "expr": {
                "Literal": {
                  "Value": "true"
                }
              }
            },
            "themedBackground": {
              "solid": {
                "color": {
                  "expr": {
                    "ThemeDataColor": {
                      "ColorId": 0,
                      "Percent": -0.1
                    }
                  }
                }
              }
            },
            "themedTitleFontColor": {
              "solid": {
                "color": {
                  "expr": {
                    "Literal": {
                      "Value": "'#47475A'"
                    }
                  }
                }
              }
            },
            "bold": {
              "expr": {
                "Literal": {
                  "Value": "false"
                }
              }
            }
          }
        }
      ],
      "background": [
        {
          "properties": {
            "color": {
              "solid": {
                "color": {
                  "expr": {
                    "Literal": {
                      "Value": "'#FAFAFA'"
                    }
                  }
                }
              }
            }
          }
        }
      ],
      "title": [
        {
          "properties": {
            "text": {
              "expr": {
                "Literal": {
                  "Value": "'Sankey Diagram Custom'"
                }
              }
            }
          }
        }
      ],
      "visualHeader": [
        {
          "properties": {
            "show": {
              "expr": {
                "Literal": {
                  "Value": "false"
                }
              }
            }
          }
        }
      ]
    },
    "drillFilterOtherVisuals": true
  }
}